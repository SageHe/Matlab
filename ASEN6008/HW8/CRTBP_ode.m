function dydt = CRTBP_ode(Z)
dydt = zeros(6,1);

mu = 0.012150585609624; 

x = Z(1);
y = Z(2);
z = Z(3);
xdot = Z(4);
ydot = Z(5);
zdot = Z(6);

phi_flat = Z(7:end);
phi = reshape(phi_flat,6,6);

R1 = sqrt((x + mu)^2 + y^2 + z^2);
R2 = sqrt((x - 1 + mu)^2 + y^2 + z^2);

xdd = 2*ydot + x - (1 - mu)*((x+mu)/(R1^3)) - mu*((x - 1 + mu)/(R2^3));
ydd = -2*xdot + y - (1 - mu)*(y/(R1^3)) - mu*(y/(R2^3));
zdd = -(1 - mu)*(z/(R1^3)) - mu*(z/(R2^3));

Amat(1,:) = [0, 0, 0, 1, 0, 0];
Amat(2,:) = [0, 0, 0, 0, 1, 0];
Amat(3,:) = [0, 0, 0, 0, 0, 1];
Amat(4,:) = [(mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) + (3*mu*(2*mu + 2*x - 2)*(mu + x - 1))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*(2*mu + 2*x)*(mu + x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)) + 1, (3*mu*y*(mu + x - 1))/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*(mu + x)*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2), (3*mu*z*(mu + x - 1))/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*z*(mu + x)*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2), 0, 2, 0];
Amat(5,:) = [(3*mu*y*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*y*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)), (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) - (3*y^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (3*mu*y^2)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) + 1, (3*mu*y*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2), -2, 0, 0];
Amat(6,:) = [(3*mu*z*(2*mu + 2*x - 2))/(2*((mu + x - 1)^2 + y^2 + z^2)^(5/2)) - (3*z*(2*mu + 2*x)*(mu - 1))/(2*((mu + x)^2 + y^2 + z^2)^(5/2)), (3*mu*y*z)/((mu + x - 1)^2 + y^2 + z^2)^(5/2) - (3*y*z*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2), (mu - 1)/((mu + x)^2 + y^2 + z^2)^(3/2) - mu/((mu + x - 1)^2 + y^2 + z^2)^(3/2) - (3*z^2*(mu - 1))/((mu + x)^2 + y^2 + z^2)^(5/2) + (3*mu*z^2)/((mu + x - 1)^2 + y^2 + z^2)^(5/2), 0, 0, 0];

phi_dot = Amat*phi;
phi_dot_flat = reshape(phi_dot,36,1);
dydt = [xdot ydot zdot xdd ydd zdd]';
dydt = [dydt;phi_dot_flat];
end
