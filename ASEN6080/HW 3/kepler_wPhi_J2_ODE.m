function zd = kepler_wPhi_J2_ODE(t,Z,const)

%Setting up function params
n = const.n;
mu = const.mu;
R = const.R;
J2 = const.J2;

% Unpack State Vector
r_vec = Z(1:3); v_vec = Z(4:6); 
x = r_vec(1); y = r_vec(2); z = r_vec(3);

Phi_flat = Z(n+1:end);
Phi = reshape(Phi_flat,n,n);

% Compute Derivatives
r = sqrt(x^2+y^2+z^2);
rdot_vec = v_vec;
vdot_vec = -(mu/r^3)*[x y z]' - (3/2)*J2*(mu/r^2)*((R/r)^2)*[(1-5*((z/r)^2))*(x/r);(1-5*((z/r)^2))*(y/r);       (3-5*((z/r)^2))*(z/r)];
Xdot_vec = [rdot_vec; vdot_vec];

A1 = [                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                                                                    0, 1, 0, 0];
A2 = [                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                                                                    0, 0, 1, 0];
A3 = [                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                                                                    0, 0, 0, 1];
A4 = [ (3*mu*x^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*R^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*R^2*mu*x^2*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*R^2*mu*x^2*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)),                                                                                                          (3*mu*x*y)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*R^2*mu*x*y*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*R^2*mu*x*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)),                                                                                                          (3*mu*x*z)/(x^2 + y^2 + z^2)^(5/2) + (3*J2*R^2*mu*x*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*R^2*mu*x*z*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)), 0, 0, 0];
A5 = [                                                                                                          (3*mu*x*y)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*R^2*mu*x*y*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*R^2*mu*x*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)), (3*mu*y^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*R^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*R^2*mu*y^2*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*R^2*mu*y^2*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)),                                                                                                          (3*mu*y*z)/(x^2 + y^2 + z^2)^(5/2) + (3*J2*R^2*mu*y*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*R^2*mu*y*z*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)), 0, 0, 0];
A6 = [                                                                                                            (3*mu*x*z)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*R^2*mu*x*z^3)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*R^2*mu*x*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)),                                                                                                            (3*mu*y*z)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*R^2*mu*y*z^3)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*R^2*mu*y*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)), (3*mu*z^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*R^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)) + (3*J2*R^2*mu*z*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*R^2*mu*z^2*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)), 0, 0, 0];
A_t = [A1;A2;A3;A4;A5;A6];

Phi_dot = A_t*Phi;

%Reformat for Output
Phi_dot_flat = reshape(Phi_dot,n^2,1);
zd = [Xdot_vec; Phi_dot_flat];

end