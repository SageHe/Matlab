function zd = keplerJ2CD_wPhi_ODE(t,Z)
Re = 6378.1363; %Earth radius in km
We = 7.2921158553e-5; % rotation rate of Earth in rads/s
A = 3e-6; % s/c cross-sectional area, km^2
m_sc = 970; %s/c mass in kg

x = Z(1);
y = Z(2);
z = Z(3);

xdot = Z(4);
ydot = Z(5);
zdot = Z(6);

mu = Z(7);
J2 = Z(8);
CD = Z(9);

xs1 = Z(10);
ys1 = Z(11);
zs1 = Z(12);

xs2 = Z(13);
ys2 = Z(14);
zs2 = Z(15);

xs3 = Z(16);
ys3 = Z(17);
zs3 = Z(18);

Xsdot1 = cross([0 0 We],[xs1 ys1 zs1]);
Xsdot2 = cross([0 0 We],[xs2 ys2 zs2]);
Xsdot3 = cross([0 0 We],[xs3 ys3 zs3]);

Phi_flat = Z(19:end);
Phi = reshape(Phi_flat,18,18);

r = sqrt(x^2 + y^2 + z^2);
xdd = - (mu*x*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)) - (7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(xdot + We*y)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc);
ydd = - (mu*y*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)) - (7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(ydot - We*x)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc);
zdd = - (mu*z*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 9*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 9*J2*Re^2*y^2 + 2*z^4 - 6*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)) - (7158264483163783*A*CD*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc);

rdot_vec = [xdot ydot zdot];
vdot_vec = [xdd ydd zdd];

rsdot_vec = [Xsdot1';Xsdot2';Xsdot3';];

xdot_vec = [rdot_vec';vdot_vec'];

Amat(1,:) = [0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(2,:) = [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(3,:) = [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(4,:) = [(7*mu*x^2*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (mu*x*(8*x^3 + 8*x*y^2 + 8*x*z^2 + 6*J2*Re^2*x))/(2*(x^2 + y^2 + z^2)^(7/2)) - (mu*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)) + (7158264483163783*A*CD*x*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(xdot + We*y)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)) + (7158264483163783*A*CD*We*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(ydot - We*x)*sign(ydot - We*x)*(xdot + We*y))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), (7*mu*x*y*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (mu*x*(8*x^2*y + 8*y^3 + 8*y*z^2 + 6*J2*Re^2*y))/(2*(x^2 + y^2 + z^2)^(7/2)) - (7158264483163783*A*CD*We*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc) + (7158264483163783*A*CD*y*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(xdot + We*y)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)) - (7158264483163783*A*CD*We*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(xdot + We*y)*sign(xdot + We*y)*(xdot + We*y))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), (7*mu*x*z*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (4*mu*x*z*(x^2 + y^2 + z^2 - 3*J2*Re^2))/(x^2 + y^2 + z^2)^(7/2) + (7158264483163783*A*CD*z*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(xdot + We*y)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(zdot)^2 + abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + xdot*abs(xdot + We*y)*sign(xdot + We*y) + We*y*abs(xdot + We*y)*sign(xdot + We*y)))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(ydot - We*x)*sign(ydot - We*x)*(xdot + We*y))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(zdot)*sign(zdot)*(xdot + We*y))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(x*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)), -(3*Re^2*mu*x*(x^2 + y^2 - 4*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)), -(7158264483163783*A*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(xdot + We*y)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc), 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(5,:) = [(7*mu*x*y*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (mu*y*(8*x^3 + 8*x*y^2 + 8*x*z^2 + 6*J2*Re^2*x))/(2*(x^2 + y^2 + z^2)^(7/2)) + (7158264483163783*A*CD*We*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc) + (7158264483163783*A*CD*x*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(ydot - We*x)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)) + (7158264483163783*A*CD*We*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(ydot - We*x)*sign(ydot - We*x)*(ydot - We*x))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), (7*mu*y^2*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (mu*y*(8*x^2*y + 8*y^3 + 8*y*z^2 + 6*J2*Re^2*y))/(2*(x^2 + y^2 + z^2)^(7/2)) - (mu*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)) + (7158264483163783*A*CD*y*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(ydot - We*x)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)) - (7158264483163783*A*CD*We*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(xdot + We*y)*sign(xdot + We*y)*(ydot - We*x))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), (7*mu*y*z*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (4*mu*y*z*(x^2 + y^2 + z^2 - 3*J2*Re^2))/(x^2 + y^2 + z^2)^(7/2) + (7158264483163783*A*CD*z*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(ydot - We*x)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(xdot + We*y)*sign(xdot + We*y)*(ydot - We*x))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(zdot)^2 + abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + ydot*abs(ydot - We*x)*sign(ydot - We*x) - We*x*abs(ydot - We*x)*sign(ydot - We*x)))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(zdot)*sign(zdot)*(ydot - We*x))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(y*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 3*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 3*J2*Re^2*y^2 + 2*z^4 - 12*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)), -(3*Re^2*mu*y*(x^2 + y^2 - 4*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)), -(7158264483163783*A*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(ydot - We*x)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc), 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(6,:) = [(7*mu*x*z*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 9*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 9*J2*Re^2*y^2 + 2*z^4 - 6*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (mu*z*(8*x^3 + 8*x*y^2 + 8*x*z^2 + 18*J2*Re^2*x))/(2*(x^2 + y^2 + z^2)^(7/2)) + (7158264483163783*A*CD*x*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)) + (7158264483163783*A*CD*We*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(ydot - We*x)*sign(ydot - We*x))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), (7*mu*y*z*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 9*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 9*J2*Re^2*y^2 + 2*z^4 - 6*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (mu*z*(8*x^2*y + 8*y^3 + 8*y*z^2 + 18*J2*Re^2*y))/(2*(x^2 + y^2 + z^2)^(7/2)) + (7158264483163783*A*CD*y*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)) - (7158264483163783*A*CD*We*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(xdot + We*y)*sign(xdot + We*y))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), (7*mu*z^2*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 9*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 9*J2*Re^2*y^2 + 2*z^4 - 6*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(9/2)) - (2*mu*z^2*(2*x^2 + 2*y^2 + 2*z^2 - 3*J2*Re^2))/(x^2 + y^2 + z^2)^(7/2) - (mu*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 9*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 9*J2*Re^2*y^2 + 2*z^4 - 6*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)) + (7158264483163783*A*CD*z*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(3512461742826138010703380722221056*m_sc*(x^2 + y^2 + z^2)^(1/2)), -(7158264483163783*A*CD*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(xdot + We*y)*sign(xdot + We*y))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(7158264483163783*A*CD*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*abs(ydot - We*x)*sign(ydot - We*x))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(7158264483163783*A*CD*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2 + zdot*sign(zdot)*abs(zdot)))/(39614081257132168796771975168*m_sc*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2)), -(z*(2*x^4 + 4*x^2*y^2 + 4*x^2*z^2 + 9*J2*Re^2*x^2 + 2*y^4 + 4*y^2*z^2 + 9*J2*Re^2*y^2 + 2*z^4 - 6*J2*Re^2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)), -(3*Re^2*mu*z*(3*x^2 + 3*y^2 - 2*z^2))/(2*(x^2 + y^2 + z^2)^(7/2)), -(7158264483163783*A*zdot*exp(Re/88667 - (x^2 + y^2 + z^2)^(1/2)/88667 + 700000/88667)*(abs(xdot + We*y)^2 + abs(ydot - We*x)^2 + abs(zdot)^2)^(1/2))/(39614081257132168796771975168*m_sc), 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(7,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(8,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(9,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(10,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -We, 0, 0, 0, 0, 0, 0,0];
Amat(11,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, We, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(12,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(13,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -We, 0, 0, 0, 0];
Amat(14,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, We, 0, 0, 0, 0, 0];
Amat(15,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
Amat(16,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -We, 0];
Amat(17,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, We, 0, 0];
Amat(18,:) = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

Phi_dot = Amat*Phi;

Phi_dot_flat = reshape(Phi_dot,18^2,1);
zd = [xdot_vec;zeros(3,1);rsdot_vec;Phi_dot_flat];
end