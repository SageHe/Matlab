function zd = proj1_ODE(time,Z,H,A,m,rho0,r0,Re,ECEF)
    % variables that don't change
    omegaE = 7.2921158553e-5;   % angular rate b/w ECI and ECEF, rad/s
    n = 18;                     % number of states

    % unpack and assign variables
    x = Z(1);
    y = Z(2);
    z = Z(3);
    xdot = Z(4);
    ydot = Z(5);
    zdot = Z(6);
    mu = Z(7);
    J2 = Z(8);
    CD = Z(9);
    
    r = (x^2 + y^2 + z^2)^(1/2);    % radius of s/c from center of Earth
    rho = rho0*exp(-(r-r0)/H);      % density of atmosphere, kg/m^3
    
    Vatm = cross([0;0;omegaE],[x;y;z]);	% atmosphere velocity, ECI
    vxatm = Vatm(1);
    vyatm = Vatm(2);
    vzatm = Vatm(3);

    % velocity of s/c relative to atmosphere (in ECI)
    Vrel = ((xdot - vxatm)^2 + (ydot - vyatm)^2 + (zdot - vzatm)^2)^(1/2);

    % accelerations due to mass of Earth
    xddot_u = -mu*x/r^3;
    yddot_u = -mu*y/r^3;
    zddot_u = -mu*z/r^3;
    
    % accelerations due to J2
    xddot_J2 = -3/2*J2*(mu/r^2)*(Re/r)^2*((1 - 5*(z/r)^2)*x/r);
    yddot_J2 = -3/2*J2*(mu/r^2)*(Re/r)^2*((1 - 5*(z/r)^2)*y/r);
    zddot_J2 = -3/2*J2*(mu/r^2)*(Re/r)^2*((3 - 5*(z/r)^2)*z/r);
    
    % drag accelerations
    xddot_FD = -.5*rho*(CD*A/m)*Vrel*(xdot - vxatm);
    yddot_FD = -.5*rho*(CD*A/m)*Vrel*(ydot - vyatm);
    zddot_FD = -.5*rho*(CD*A/m)*Vrel*(zdot - vzatm);
    
    % total accelerations
    xddot = xddot_u + xddot_J2 + xddot_FD;
    yddot = yddot_u + yddot_J2 + yddot_FD;
    zddot = zddot_u + zddot_J2 + zddot_FD;   
    
    if ECEF ==1
        % A matrix
        Amat = [

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 1,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 1,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                1,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
          (3*mu*x^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*Re^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*x^2*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x^2*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*x*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)), (3*mu*x*y)/(x^2 + y^2 + z^2)^(5/2) - (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (15*J2*Re^2*mu*x*y*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) - (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)^2)/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*y*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                              (3*mu*x*z)/(x^2 + y^2 + z^2)^(5/2) + (3*J2*Re^2*mu*x*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*x*z*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*rho0*z*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)), - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(2*xdot + 2*omegaE*y))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                                       -(A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(2*ydot - 2*omegaE*x))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                       -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), (3*J2*Re^2*x*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - x/(x^2 + y^2 + z^2)^(3/2), (3*Re^2*mu*x*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)), -(A*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m), 0, 0, 0, 0, 0, 0, 0, 0, 0;
        (3*mu*x*y)/(x^2 + y^2 + z^2)^(5/2) + (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (15*J2*Re^2*mu*x*y*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)^2)/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*x*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),   (3*mu*y^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*Re^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*y^2*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*y^2*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) - (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*y*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                              (3*mu*y*z)/(x^2 + y^2 + z^2)^(5/2) + (3*J2*Re^2*mu*y*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*y*z*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*rho0*z*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                                                       -(A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*(2*xdot + 2*omegaE*y))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*(2*ydot - 2*omegaE*x))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                       -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), (3*J2*Re^2*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - y/(x^2 + y^2 + z^2)^(3/2), (3*Re^2*mu*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)), -(A*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m), 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                (3*mu*x*z)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*Re^2*mu*x*z^3)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*omegaE*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*x*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                                                                         (3*mu*y*z)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*Re^2*mu*y*z^3)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*y*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)) - (A*CD*omegaE*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*y*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)), (3*mu*z^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*Re^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)) + (3*J2*Re^2*mu*z*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*z^2*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*rho0*z*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                                                                    -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(2*xdot + 2*omegaE*y))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                                                    -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(2*ydot - 2*omegaE*x))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (A*CD*rho0*zdot^2*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), (3*J2*Re^2*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)) - z/(x^2 + y^2 + z^2)^(3/2), (3*Re^2*mu*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)),              -(A*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m), 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        % reshape STM
        Phi = reshape(Z(n+1:end),n,n);

        % DKE
        Phi_dot = Amat*Phi;

        % reshape into (n^+n)x1 array to be integrated
        zd = [xdot; ydot; zdot; xddot; yddot; zddot; zeros(12,1); reshape(Phi_dot,n^2,1)];
    else % if ECI
        Amat = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 1,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 1,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                1,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
              (3*mu*x^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*Re^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*x^2*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x^2*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*x*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)), (3*mu*x*y)/(x^2 + y^2 + z^2)^(5/2) - (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (15*J2*Re^2*mu*x*y*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) - (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)^2)/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*y*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                              (3*mu*x*z)/(x^2 + y^2 + z^2)^(5/2) + (3*J2*Re^2*mu*x*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*x*z*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*rho0*z*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)), - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(2*xdot + 2*omegaE*y))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                                       -(A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(2*ydot - 2*omegaE*x))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                       -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), (3*J2*Re^2*x*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - x/(x^2 + y^2 + z^2)^(3/2), (3*Re^2*mu*x*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)), -(A*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m),      0,       0, 0,      0,       0, 0,      0,       0, 0;
            (3*mu*x*y)/(x^2 + y^2 + z^2)^(5/2) + (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (15*J2*Re^2*mu*x*y*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)^2)/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*x*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),   (3*mu*y^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*Re^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*y^2*z^2)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*y^2*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) - (A*CD*omegaE*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*y*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                              (3*mu*y*z)/(x^2 + y^2 + z^2)^(5/2) + (3*J2*Re^2*mu*y*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*y*z*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*rho0*z*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                                                       -(A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*(2*xdot + 2*omegaE*y))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*(2*ydot - 2*omegaE*x))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                       -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), (3*J2*Re^2*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)) - y/(x^2 + y^2 + z^2)^(3/2), (3*Re^2*mu*y*((5*z^2)/(x^2 + y^2 + z^2) - 1))/(2*(x^2 + y^2 + z^2)^(5/2)), -(A*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m),      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                    (3*mu*x*z)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*Re^2*mu*x*z^3)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*x*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*omegaE*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(ydot - omegaE*x))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*x*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                                                                         (3*mu*y*z)/(x^2 + y^2 + z^2)^(5/2) - (15*J2*Re^2*mu*y*z^3)/(x^2 + y^2 + z^2)^(9/2) - (15*J2*Re^2*mu*y*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)) - (A*CD*omegaE*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(xdot + omegaE*y))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)) + (A*CD*rho0*y*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)), (3*mu*z^2)/(x^2 + y^2 + z^2)^(5/2) - mu/(x^2 + y^2 + z^2)^(3/2) + (3*J2*Re^2*mu*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)) + (3*J2*Re^2*mu*z*((10*z)/(x^2 + y^2 + z^2) - (10*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)^(5/2)) - (15*J2*Re^2*mu*z^2*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(7/2)) + (A*CD*rho0*z*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*H*m*(x^2 + y^2 + z^2)^(1/2)),                                                                                                                                    -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(2*xdot + 2*omegaE*y))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)),                                                                                                                                    -(A*CD*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*(2*ydot - 2*omegaE*x))/(4*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), - (A*CD*rho0*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m) - (A*CD*rho0*zdot^2*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H))/(2*m*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2)), (3*J2*Re^2*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)) - z/(x^2 + y^2 + z^2)^(3/2), (3*Re^2*mu*z*((5*z^2)/(x^2 + y^2 + z^2) - 3))/(2*(x^2 + y^2 + z^2)^(5/2)),              -(A*rho0*zdot*exp((r0 - (x^2 + y^2 + z^2)^(1/2))/H)*((xdot + omegaE*y)^2 + (ydot - omegaE*x)^2 + zdot^2)^(1/2))/(2*m),      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0, -omegaE, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0, omegaE,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0, -omegaE, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0, omegaE,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0, -omegaE, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0, omegaE,       0, 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                0,                                                                                                     0,                                                                         0,                                                                                                                                  0,      0,       0, 0,      0,       0, 0,      0,       0, 0];

        % reshape STM
        Phi = reshape(Z(n+1:end),n,n);

        % DKE
        Phi_dot = Amat*Phi;
        
        % station velocities in terms of their positions (ECI)
        Vs1 = [-Z(11)*omegaE; Z(10)*omegaE; 0];
        Vs2 = [-Z(14)*omegaE; Z(13)*omegaE; 0];
        Vs3 = [-Z(17)*omegaE; Z(16)*omegaE; 0];

        % reshape into (n^+n)x1 array to be integrated
        zd = [xdot; ydot; zdot; xddot; yddot; zddot; 0; 0; 0; Vs1; Vs2; Vs3; reshape(Phi_dot,n^2,1)]; 
    end
end